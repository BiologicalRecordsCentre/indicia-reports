<report
    title="EBMS species list viewer 2"
    description="Based on /reports/library/taxa/taxon_list, with enhancements such as a country/region filter.
    Version 2 includes speed improvements, and also a better way of displaying common names."
>
  <query website_filter_field="pix.website_id">
    WITH preferred_insect_taxa AS (
    SELECT
      cttl.id,
      cttl.taxon_meaning_id,
      cttl.external_key,
      cttl.taxon,
      cttl.taxon_list_id,
      cttl.taxon_group,
      cttl.taxon_rank,
      cttl.taxon_rank_id
    FROM cache_taxa_taxon_lists cttl
    WHERE cttl.taxon_list_id IN (#butterfly_taxon_list_id#,#moth_taxon_list_id#,#bumblebee_taxon_list_id#,#dragonfly_taxon_list_id#)
      AND cttl.allow_data_entry = true
      AND cttl.preferred = true
    ),
    insect_taxa_synonyms AS (
    SELECT
      taxon_meaning_id,
      string_agg(DISTINCT taxon, ',' ORDER BY taxon) AS synonyms
    FROM cache_taxa_taxon_lists
    WHERE taxon_list_id IN (#butterfly_taxon_list_id#,#moth_taxon_list_id#,#bumblebee_taxon_list_id#,#dragonfly_taxon_list_id#)
      AND language_iso = 'lat' and preferred = false
      AND '#include_synonyms#' = '1'
    GROUP BY taxon_meaning_id
    ),
    insect_taxa_common_names AS (
    SELECT
      cttl_all_taxon_meanings.taxon_meaning_id,
      CASE WHEN '#common_names_language#' != ''
        THEN
          string_agg(
            case when 
              cttl_commons.taxon IS NULL
            THEN '' 
            ELSE cttl_commons.taxon
            END,',' order by lang.id
          )
        ELSE
          ''
        END AS common_names
    FROM cache_taxa_taxon_lists cttl_all_taxon_meanings
    JOIN languages lang ON lang.id != 2 AND lang.deleted=false
      AND (lang.iso = '#common_names_language#' OR '#common_names_language#' = 'all')
    LEFT JOIN cache_taxa_taxon_lists cttl_commons on cttl_commons.taxon_meaning_id = cttl_all_taxon_meanings.taxon_meaning_id
      AND cttl_commons.preferred = false
      AND (cttl_commons.language_iso = '#common_names_language#' OR '#common_names_language#' = 'all')
      AND cttl_commons.taxon_list_id in 
        (#butterfly_taxon_list_id#,#moth_taxon_list_id#,#bumblebee_taxon_list_id#,#dragonfly_taxon_list_id#)
      AND cttl_commons.language_iso = lang.iso
      AND cttl_commons.language_iso != 'lat'
    WHERE cttl_all_taxon_meanings.taxon_list_id in 
      (#butterfly_taxon_list_id#,#moth_taxon_list_id#,#bumblebee_taxon_list_id#,#dragonfly_taxon_list_id#)
      AND
        (#taxon_list_filter# = 0 OR
        (#taxon_list_filter# = #butterfly_taxon_list_id# AND cttl_all_taxon_meanings.taxon_list_id = #butterfly_taxon_list_id#) OR
        (#taxon_list_filter# = #moth_taxon_list_id# AND cttl_all_taxon_meanings.taxon_list_id = #moth_taxon_list_id#) OR
        (#taxon_list_filter# = #bumblebee_taxon_list_id# AND cttl_all_taxon_meanings.taxon_list_id = #bumblebee_taxon_list_id#) OR
        (#taxon_list_filter# = #dragonfly_taxon_list_id# AND cttl_all_taxon_meanings.taxon_list_id = #dragonfly_taxon_list_id#))
      AND ('#include_higher_level_taxa#' = '1'
        OR ('#include_higher_level_taxa#' = '0' AND cttl_all_taxon_meanings.taxon_rank_id in (2,10,26,38,49,64)))
      AND cttl_all_taxon_meanings.allow_data_entry = true
      AND cttl_all_taxon_meanings.preferred = true
      AND lang.iso IN
        (
        SELECT cttl_lang.language_iso
        FROM cache_taxa_taxon_lists cttl_lang
        WHERE cttl_lang.language_iso = lang.iso
        AND cttl_lang.taxon_list_id in (#butterfly_taxon_list_id#,#moth_taxon_list_id#,#bumblebee_taxon_list_id#,#dragonfly_taxon_list_id#)
        )
      AND (
        '#one_common_name_per_language#' = '0' 
        OR cttl_commons.id IS NULL
        OR 
        ('#one_common_name_per_language#' = '1' AND cttl_commons.id IN
        (SELECT max(cttl_commons2.id)
           FROM cache_taxa_taxon_lists cttl_commons2
           WHERE cttl_commons2.taxon_meaning_id = cttl_commons.taxon_meaning_id 
             AND cttl_commons2.preferred = false
             AND cttl_commons2.taxon_list_id in 
             (#butterfly_taxon_list_id#,#moth_taxon_list_id#,#bumblebee_taxon_list_id#,#dragonfly_taxon_list_id#)
             AND cttl_commons2.language_iso != 'lat'
             AND (cttl_commons2.language_iso = '#common_names_language#' OR '#common_names_language#' = 'all')
           GROUP BY cttl_commons2.language_iso)))
      GROUP BY cttl_all_taxon_meanings.taxon_meaning_id
    ),
    species_list_countries_and_profiles AS (
      SELECT distinct ttl.taxon_meaning_id
      FROM taxa_taxon_list_attributes ttla
      LEFT JOIN taxa_taxon_list_attribute_values ttlav on ttla.id = ttlav.taxa_taxon_list_attribute_id
        AND ttlav.deleted = false
      LEFT JOIN taxa_taxon_lists ttl on ttl.id = ttlav.taxa_taxon_list_id
      WHERE
      ttla.deleted=false
      AND ttla.termlist_id = #species_presence_termlist_id#
      AND ttla.id in 
          (#european_country_ttl_attr_ids#,
          #north_american_country_ttl_attr_ids#,
          #south_american_country_ttl_attr_ids#,
          #african_country_ttl_attr_ids#,
          #asian_country_ttl_attr_ids#,
          #oceania_country_ttl_attr_ids#)
      AND (ttlav.int_value = #species_presence_filter# OR #species_presence_filter# = 0)
      AND 
        (#country_region_ttl_attr_id# = ttla.id  OR
         #country_region_ttl_attr_id# = 0 OR
        (#country_region_ttl_attr_id# = -1 AND ttla.id in (#european_country_ttl_attr_ids#)) OR
        (#country_region_ttl_attr_id# = -2 AND ttla.id in (#north_american_country_ttl_attr_ids#)) OR
        (#country_region_ttl_attr_id# = -3 AND ttla.id in (#south_american_country_ttl_attr_ids#)) OR
        (#country_region_ttl_attr_id# = -4 AND ttla.id in (#african_country_ttl_attr_ids#)) OR
        (#country_region_ttl_attr_id# = -5 AND ttla.id in (#asian_country_ttl_attr_ids#)) OR
        (#country_region_ttl_attr_id#= -6 AND ttla.id in (#oceania_country_ttl_attr_ids#)))
    )
    SELECT #columns#
    FROM preferred_insect_taxa pix
    LEFT JOIN insect_taxa_synonyms cttl_syn on cttl_syn.taxon_meaning_id = pix.taxon_meaning_id
    LEFT JOIN insect_taxa_common_names cttl_com on cttl_com.taxon_meaning_id = pix.taxon_meaning_id
    LEFT JOIN taxon_media tm on 
      tm.taxon_meaning_id = pix.taxon_meaning_id
      AND tm.deleted=false
    LEFT JOIN species_list_countries_and_profiles profiles on
      profiles.taxon_meaning_id = pix.taxon_meaning_id
    WHERE   
      (#taxon_list_filter# = 0 OR
      (#taxon_list_filter# = 251 AND pix.taxon_list_id = #butterfly_taxon_list_id#) OR
      (#taxon_list_filter# = 260 AND pix.taxon_list_id = #moth_taxon_list_id#) OR
      (#taxon_list_filter# = 261 AND pix.taxon_list_id = #bumblebee_taxon_list_id#) OR
      (#taxon_list_filter# = 265 AND pix.taxon_list_id = #dragonfly_taxon_list_id#))
    AND ('#include_higher_level_taxa#' = '1'
      OR ('#include_higher_level_taxa#' = '0' AND pix.taxon_rank_id in (2,10,26,38,49,64)))
    AND (profiles.taxon_meaning_id IS NOT NULL OR (#country_region_ttl_attr_id# = 0 AND #species_presence_filter# = 0))
  </query>
  <order_bys>
    <order_by>pix.taxon_list_id, pix.taxon</order_by>
  </order_bys>
  <params>
    <param name="taxon_list_filter" display="Taxon group"
      datatype="lookup" emptyvalue="0"
      lookup_values="251:Butterflies,260:Moths,261:Bumblebees,265:Dragonflies" 
      description="Choose from butterflies, moths, bumblebees, or dragonflies."/>
    <param name="include_higher_level_taxa" display="Include higher level taxa?"
      datatype="checkbox" description="Include higher level taxa? (above species aggregate)."/>
    <param name="country_region_ttl_attr_id" display="Continent/country/region" datatype="lookup"
      population_call="
      report:projects/ebms/ebms_countries_regions_for_taxon_list_viewer_lookup:id:name:orderby=orderby_name"
      description="Continent, country or region." emptyvalue="0"/>
    <param name="species_presence_filter" display="Filter based on species presence" description='Change to "all" if you wish to return any presence status.' 
      datatype="lookup" emptyvalue="0"
      lookup_values="16407:P,16408:P?,16406:A,16409:M,16410:I,16411:Ex" />
    <param name="common_names_language" datatype="lookup" display="Include common names?"
      description="Limit common names language" 
      population_call="report:projects/ebms/ebms_languages_for_taxon_list_viewer_lookup:iso:language:orderby=id" />
    <param name="include_synonyms" datatype="checkbox" display="Include synonyms?" 
        description="Include synonyms in results?" />
    <param name="one_common_name_per_language" datatype="checkbox" display="Display one common name per language?" 
        description="When displaying common names, only show one name per language for a more sturctured download."  />
    <param name="european_country_ttl_attr_ids" datatype="string" display="European TTL Attribute IDs"
        description="Comma separated European taxa taxon list attribute IDs" />
    <param name="north_american_country_ttl_attr_ids" datatype="string" display="North American TTL Attribute IDs"
        description="Comma separated North American taxa taxon list attribute IDs" />
    <param name="south_american_country_ttl_attr_ids" datatype="string" display="South American TTL Attribute IDs"
        description="Comma separated South American taxa taxon list attribute IDs" />
    <param name="african_country_ttl_attr_ids" datatype="string" display="African TTL Attribute IDs"
        description="Comma separated African taxa taxon list attribute IDs" />
    <param name="asian_country_ttl_attr_ids" datatype="string" display="Asian TTL Attribute IDs"
        description="Comma separated Asian taxa taxon list attribute IDs" />
    <param name="oceania_country_ttl_attr_ids" datatype="string" display="Oceania TTL Attribute IDs"
        description="Comma separated Oceania taxa taxon list attribute IDs" />
    <param name="species_presence_termlist_id" display="Species presence termlist_id" datatype="int" />
    <param name="countries_regions_location_type_ids" display="Countries location type IDs" datatype="int" />
    <param name="butterfly_taxon_list_id" display="ID of the butterfly species list" datatype="int" />
    <param name="moth_taxon_list_id" display="ID of the moth species list" datatype="int" />
    <param name="bumblebee_taxon_list_id" display="ID of the bumblebee species list" datatype="int" />
    <param name="dragonfly_taxon_list_id" display="ID of the dragonfly species list" datatype="int" />
  </params>
  <columns>
    <column name='id' display='ID'
            sql='pix.id' in_count="true" datatype="integer" />
    <column name='taxon_meaning_id' display='Taxon Meaning ID'
            sql='pix.taxon_meaning_id' visible="false" datatype="integer" />
    <column name='external_key' display='External key'
            sql='pix.external_key' visible="false" datatype="text" />
    <column name='taxon' display='Taxon name'
            sql="pix.taxon" datatype="text" />
    <column name='common' display='Common names'
            sql="cttl_com.common_names" datatype="text" />
    <column name='synonyms' display='Synonyms'
            sql="cttl_syn.synonyms" datatype="text" />
    <column name='taxon_group' display='Taxon group'
            sql="
            CASE WHEN pix.taxon_list_id = #butterfly_taxon_list_id#
            THEN 'Butterfly'
            WHEN pix.taxon_list_id = #moth_taxon_list_id#
            THEN 'Moth'
            WHEN pix.taxon_list_id = #bumblebee_taxon_list_id#
            THEN 'Bumblebee'
            WHEN pix.taxon_list_id = #dragonfly_taxon_list_id#
            THEN 'Dragonfly'
            ELSE pix.taxon_group END
            " datatype="text" />
    <column name='taxon_list_id' display='Taxon list ID' sql='pix.taxon_list_id' visible="false" datatype="integer" />
    <column name='taxon_rank' display='Taxon rank' sql='pix.taxon_rank' datatype="text" />
     <column name='path' display='Images' sql="tm.path" img='true' />
  </columns>
</report>
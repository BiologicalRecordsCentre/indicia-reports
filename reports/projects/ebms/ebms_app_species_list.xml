<?xml version="1.0" encoding="UTF-8"?>
<report title="EBMS App species list report"
        description="Lists species to be used in the App.">
  <query website_filter_field="">
  SELECT #columns#
  FROM cache_taxa_taxon_lists cttl
  JOIN cache_taxa_taxon_lists cttl_meaning on cttl_meaning.taxon_meaning_id = cttl.taxon_meaning_id
    AND cttl_meaning.allow_data_entry = true
  LEFT JOIN taxa_taxon_list_attribute_values ttlav
    ON ttlav.taxa_taxon_list_id = cttl_meaning.id
    AND ((ttlav.taxa_taxon_list_attribute_id = #id# and '#type#' = 'location')
      OR ttlav.taxa_taxon_list_attribute_id = 0)
    AND ttlav.int_value in (16407,16408,16409,16410)
    AND ttlav.deleted = false
  LEFT JOIN taxa_taxon_list_attributes ttla
    ON ttla.id = ttlav.taxa_taxon_list_attribute_id
    AND ttla.termlist_id=816
    AND ttla.deleted = false
  LEFT JOIN locations l on l.code = ttla.caption
    AND l.deleted = false and l.location_type_id in (16516, 16517)
  WHERE 
  cttl.taxon_list_id in (251,260,261,265) AND
  (
    (lower('#type#') = 'list' AND cttl.taxon_list_id = #id#) 
    OR (lower('#type#') = 'location' AND ttla.id = #id#) 
    OR #id# = 0
    OR '#type#' = ''
  )
  AND cttl.allow_data_entry = true
  </query>
  <order_bys>
    <order_by>cttl.taxon_list_id, cttl.taxonomic_sort_order nulls first, cttl.preferred_taxa_taxon_list_id</order_by>
  </order_bys>
  <params>
    <param name="id" display="List ID" description="ID of the list (taxon attribute ID or taxon list ID)" datatype="integer" emptyvalue='0' />
    <param name="type" display="ID Type" description="Enter 'location' or 'list'." datatype="string" emptyvalue='' />
  </params>
  <columns>
    <column name="taxa_taxon_list_id" sql="cttl.id" incount="true" />
    <column name="parent_id" sql="cttl.parent_id" />
    <column name="preferred_taxa_taxon_list_id" sql="cttl.preferred_taxa_taxon_list_id" />
    <column name="taxon_meaning_id" sql="cttl.taxon_meaning_id" />
    <column name="taxon_id" sql="cttl.taxon_id" />
    <column name="external_key" sql="cttl.external_key" />
    <column name="taxon" sql="cttl.taxon" />
    <column name="preferred_taxon" sql="cttl.preferred_taxon" />
    <column name="taxon_group_id" sql="cttl.taxon_group_id" />
    <column name="attributes" sql="
    (select json_object_agg(ttla.caption, t.term order by ttla.caption)
   from taxa_taxon_list_attributes ttla
   join taxa_taxon_list_attribute_values ttlav on ttlav.taxa_taxon_list_id=cttl.preferred_taxa_taxon_list_id and ttlav.taxa_taxon_list_attribute_id=ttla.id
   join cache_termlists_terms t on t.id=ttlav.int_value)
   " aggregate="true"/>
    <column name="language_iso" sql="cttl.language_iso" />
    <column name="taxonomic_sort_order" sql="cttl.taxonomic_sort_order" />
  </columns>
</report>
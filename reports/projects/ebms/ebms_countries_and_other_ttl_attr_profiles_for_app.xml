<report
    title="EBMS Countries And Other TTL Attribute Profiles For App"
    description="Return EBMS country and taxon list profiles for app"
>
  <query>
  SELECT 
    tl.id as id,
    'list' as type,
    null as location_code,
    tl.title as name,
    tl.description as description,
    null as coordinates,
    count(distinct ttl.taxon_meaning_id) as taxa_count,
    '[' || string_agg(distinct t.taxon_group_id::text, ', ') || ']' as species_groups,
    max(ttl.updated_on) as updated_on,
    null as dist
    FROM taxon_lists tl
    LEFT JOIN taxa_taxon_lists ttl on ttl.taxon_list_id = tl.id
      AND ttl.deleted = false
      AND ttl.allow_data_entry = true
    LEFT JOIN taxa t on t.id = ttl.taxon_id AND t.deleted=false
    WHERE tl.id in (251,260,261,265)
      AND ('#location_code_filter#' = '')
      AND (tl.title ILIKE '%' || '#name_filter#' || '%' OR '#name_filter#' = '')
      AND (tl.description ILIKE '%' || '#description_filter#' || '%' OR '#description_filter#' = '')
      AND (t.taxon_group_id in (#species_groups_filter#) OR '#species_groups_filter#' = '0')
      AND (ttl.updated_on &gt;= '#updated_on_filter#'::timestamp)
    GROUP BY tl.id, tl.title, tl.description

    UNION

    SELECT 
    ttla.id as id,
    'location' as type,
    ttla.caption as location_code,
    CASE WHEN l.name IS NOT NULL THEN l.name
      WHEN ttla.caption = 'GR' THEN 'Greece'
      WHEN ttla.caption = 'Europe' THEN 'Europe'
      WHEN ttla.caption = 'PT: AZ' THEN 'Azores'
      WHEN ttla.caption = 'PT: MA' THEN 'Madeira Islands'
      WHEN ttla.caption = 'ES: CA' THEN 'Canary Islands'
    END as name,
    ttla.description as description,
    CASE WHEN centroid_sref LIKE '%N %' OR centroid_sref LIKE '%S %' THEN
    ARRAY[
      CASE
        WHEN position('S' in centroid_sref) &gt; 0 THEN -CAST(split_part(centroid_sref, 'S', 1) AS double precision)
      ELSE CAST(split_part(centroid_sref, 'N', 1) AS double precision)
      END,
      CASE
        WHEN position('W' in centroid_sref) &gt; 0 THEN -CAST(split_part(split_part(centroid_sref, ' ', 2), 'W', 1) AS double precision)
      ELSE CAST(split_part(split_part(centroid_sref, ' ', 2), 'E', 1) AS double precision)
      END
    ]
    ELSE null
    END AS coordinates,
    count(distinct ttl.taxon_meaning_id) as taxa_count,
    '[' || string_agg(distinct t.taxon_group_id::text, ', ') || ']' as species_groups,
    max(ttl.updated_on) as updated_on,
    CASE WHEN '#lon#' = '1000' OR '#lat#' = '1000'
      THEN
        null
      ELSE
        ST_Distance(
          ST_SetSRID(ST_MakePoint(#lon#, #lat#), 4326), 
          st_transform(coalesce(l.boundary_geom, l.centroid_geom),4326)
        )
      END as dist
    FROM taxa_taxon_list_attributes ttla
    JOIN taxon_lists_taxa_taxon_list_attributes tlttla 
      ON tlttla.taxa_taxon_list_attribute_id = ttla.id
      AND tlttla.taxon_list_id in (251,260,261,265)
      AND tlttla.deleted=false
    LEFT JOIN taxa_taxon_list_attribute_values ttlav on
      ttlav.taxa_taxon_list_attribute_id = ttla.id
      AND ttlav.int_value in (16407,16408,16409,16410)
      AND ttlav.deleted = false
    LEFT JOIN taxa_taxon_lists ttl on ttl.id = ttlav.taxa_taxon_list_id
      AND ttl.deleted = false
      AND ttl.allow_data_entry = true
    LEFT JOIN taxa t on t.id = ttl.taxon_id AND t.deleted=false
    LEFT JOIN locations l on 
      (l.code = ttla.caption OR 
      (l.code='UK' AND ttla.caption='GB') OR
      (l.code='SH' AND ttla.caption='SH: HL'))
      AND l.deleted = false and l.location_type_id in (16516, 16517)

    WHERE termlist_id = 816
      AND ttla.deleted = false
      AND (ttla.caption = '#location_code_filter#' OR '#location_code_filter#' = '')
      AND (l.name ILIKE '%' || '#name_filter#' || '%' OR '#name_filter#' = '')
      AND (ttla.description ILIKE '%' || '#description_filter#' || '%' OR '#description_filter#' = '')
      AND (t.taxon_group_id in (#species_groups_filter#) OR '#species_groups_filter#' = '0')
      AND (ttl.updated_on &gt;= '#updated_on_filter#'::timestamp)
      GROUP BY ttla.id, ttla.caption, l.name, ttla.description, l.centroid_sref,l.boundary_geom,l.centroid_geom
      ORDER BY dist, name
  </query>
  <params>
    <param name='location_code_filter' display='Location code filter' description='Location code filter - exact match.' datatype='string'/>
    <param name='name_filter' display='Name filter' description='Case insensitive "contains" name filter.' datatype='string'/>
    <param name='description_filter' display='Description filter' description='Case insensitive "contains" description filter.' datatype='string'/>
    <param name='lon' display='Longitude' description='Longitude coordinate.' emptyvalue='1000' datatype='string'/>
    <param name='lat' display='Latitude' description='Latitude coordinate.' emptyvalue='1000' datatype='string'/>
    <param name='species_groups_filter' display='Species groups filter' description='Taxon groups filter. Accepts a comma separated list.' datatype='string' emptyvalue="0" />
    <param name='updated_on_filter' display='Updated on filter' description='Return rows which are on or later than this date (format YYYY-MM-DD).' datatype='string' emptyvalue='2000-01-01' />
  </params>
  <columns>
    <column name='id' display='ID' datatype="int" />
    <column name='type' display='Type' datatype="text" />
    <column name='location_code' display='Location code' datatype="text" />
    <column name='name' display='Name' datatype="text" />
    <column name='description' display='Description' datatype="text" />
    <column name='coordinates' display='Coordinates' datatype="text" />
    <column name='taxa_count' display='Taxon count' datatype="int"  />
    <column name='species_groups' display='Species groups' datatype="json"  />
    <column name='updated_on' display='Updated on' datatype="text" />
    <column name='dist' display='Distance' datatype="text" />
  </columns>
</report>